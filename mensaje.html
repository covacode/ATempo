<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATempo | Cronómetro</title>
    <link rel="stylesheet" href="fontawesome/css/all.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCWWsVzpfPYQmjNa5kW_5_7FmwM9wjQX3Q",
            authDomain: "atempo-sacb.firebaseapp.com",
            projectId: "atempo-sacb",
            storageBucket: "atempo-sacb.appspot.com",
            messagingSenderId: "954859089085",
            appId: "1:954859089085:web:f79f743bbd836eed7d1bd4",
            databaseURL: "https://atempo-sacb-default-rtdb.firebaseio.com/"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a los nodos en la base de datos
            const messagesRef = ref(database, 'messages');
            const timerRef = ref(database, 'timer');

            // Mostrar solo el último mensaje en tiempo real
            onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val();
                const messageDisplay = document.getElementById('message-display');
                messageDisplay.innerHTML = '';

                if (messages) {
                    // Obtener el último mensaje
                    const keys = Object.keys(messages);
                    const lastKey = keys[keys.length - 1];
                    const lastMessage = messages[lastKey];
                    messageDisplay.innerHTML = `<p>${lastMessage}</p>`;
                }
            });


            // Actualizar cronómetro en tiempo real
            let timerInterval;
            function updateTimer(minutes) {
                const endTime = Date.now() + minutes * 60000;

                if (timerInterval) {
                    clearInterval(timerInterval);
                }

                function displayTime() {
                    const remainingTime = endTime - Date.now();
                    if (remainingTime <= 0) {
                        clearInterval(timerInterval);
                        document.getElementById('timer-display').textContent = '00:00';
                    } else {
                        const minutesLeft = Math.floor(remainingTime / 60000);
                        const secondsLeft = Math.floor((remainingTime % 60000) / 1000);
                        document.getElementById('timer-display').textContent = 
                            `${String(minutesLeft).padStart(2, '0')}:${String(secondsLeft).padStart(2, '0')}`;
                    }
                }

                displayTime(); // Inicializar la visualización del tiempo
                timerInterval = setInterval(displayTime, 1000); // Actualizar cada segundo
            }

            onValue(timerRef, (snapshot) => {
                const minutes = snapshot.val();
                const minutesDisplay = document.getElementById('timer-display');
                minutesDisplay.textContent = '00:00';

                if (minutes) {
                    // Obtener el último mensaje
                    const keys = Object.keys(minutes);
                    const lastKey = keys[keys.length - 1];
                    const lastTimer = minutes[lastKey];
                    updateTimer(lastTimer);
                }
                else{
                    document.getElementById('timer-display').textContent = '00:00';
                }
            });

            /*onValue(timerRef, (snapshot) => {
                const minutes = snapshot.val();
                if (minutes) {
                    updateTimer(minutes);
                } else {
                    document.getElementById('timer-display').textContent = '00:00';
                }
            });*/
        });
    </script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center"><i class="far fa-clock"></i> ATempo</h1>
        <div class="text-center mb-4 mt-5">
            <p id="message-display" class="h2 text-danger">Esperando mensaje...</p>
            <strong id="timer-display" class="h1">00:00</strong>
        </div>
    </div>
</body>
</html>
